<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Title</title>
    </head>
    <body>
        <input id="store-key" type="text" placeholder="存储的 key"> <br> <br>
        <textarea id="store-value" cols="30" rows="10" placeholder="存储的 value"></textarea> <br> <br>
        <div id="result"></div>
        <button id="btn-get">get</button>
        <button id="btn-set">set</button>
        <button id="btn-remove">remove</button>
        <button id="btn-clear">clear</button>

        <script type="module">
            var uuidv4 = () => {
                return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
                    var r = Math.random() * 16 | 0, v = c === "x" ? r : r & 3 | 8;
                    return v.toString(16);
                });
            };
            var Cellar = class {
                #inner;

                get #ctx() {
                    return this.#inner.contentWindow;
                }

                #ready;
                get ready() {
                    return this.#ready;
                }

                #resp = /* @__PURE__ */ new Map();

                #setupListener() {
                    window.addEventListener("message", (ev) => {
                        console.log('received message', ev)
                        try {
                            const { proof, result } = ev.data;
                            const resp = this.#resp.get(proof);
                            if (resp) {
                                resp(result);
                                this.#resp.delete(proof);
                            }
                        } catch (err) {
                            console.error("fail to handle message", ev, err);
                        }
                    });
                }

                constructor(uri) {
                    const tryGet = document.getElementById("cellar-inner");
                    if (tryGet) {
                        this.#inner = tryGet;
                        this.#ready = Promise.resolve();
                    }
                    else {
                        const cellar = document.createElement("iframe");
                        this.#inner = cellar;
                        cellar.id = "cellar-inner";
                        cellar.src = uri;
                        cellar.style.display = "none";
                        document.body.appendChild(cellar);
                        this.#ready = new Promise((resolve, reject) => {
                            cellar.onload = () => {
                                resolve();
                            };
                            cellar.onerror = (err) => {
                                reject(err);
                            };
                        });
                    }
                    this.#setupListener();
                }

                async common(fn, args) {
                    const sig = uuidv4();
                    const instance = this;
                    return new Promise((resolve) => {
                        instance.#resp.set(sig, resolve);
                        instance.#ctx.postMessage({
                            proof: sig,
                            fn,
                            args
                        }, "*");
                    });
                }

                async getItem(key) {
                    return this.common("getItem", [ key ]);
                }

                async setItem(key, value) {
                    return this.common("setItem", [ key, value ]);
                }

                async removeItem(key) {
                    return this.common("removeItem", [ key ]);
                }

                async clear() {
                    return this.common("clear", []);
                }
            };


            const cellar = new Cellar('https://assets.catalystplus.cn/cellar/cellar.html')

            await cellar.ready
            console.log('cellar ready')

            const store_key = document.getElementById('store-key')
            const store_value = document.getElementById('store-value')
            const result = document.getElementById('result')

            const btn_get = document.getElementById('btn-get')
            const btn_set = document.getElementById('btn-set')
            const btn_remove = document.getElementById('btn-remove')
            const btn_clear = document.getElementById('btn-clear')

            btn_get.onclick = async () => {
                if (!store_key.value) return
                console.log('exec get')
                result.innerText = await cellar.getItem(store_key.value)
            }
            btn_set.onclick = async () => {
                if (!store_key.value) return
                if (!store_value.value) return
                console.log('exec set')
                result.innerText = await cellar.setItem(store_key.value, store_value.value)
            }
            btn_remove.onclick = async () => {
                if (!store_key.value) return
                console.log('exec remove')
                result.innerText = await cellar.removeItem(store_key.value)
            }
            btn_clear.onclick = async () => {
                console.log('exec clear')
                result.innerText = await cellar.clear()
            }
        </script>
    </body>
</html>
